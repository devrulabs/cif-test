<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamics 365 CIF Testing Dashboard</title>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div id="root"></div>

    <script>
        const CIFTestDashboard = () => {
            const [status, setStatus] = React.useState('Not Initialized');
            const [logs, setLogs] = React.useState([]);
            const [selectedFunction, setSelectedFunction] = React.useState('');
            const [functionParams, setFunctionParams] = React.useState('');
            const [currentMode, setCurrentMode] = React.useState(null);

            // Add log entry with timestamp
            const addLog = (message, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                setLogs(prev => [...prev, { message, timestamp, type }]);
            };

            // Initialize CIF
            const initializeCIF = async () => {
                try {
                    setStatus('Initializing...');
                    const script = document.createElement('script');
                    const apiSrc = `${document.referrer}/webresources/Widget/msdyn_ciLibrary.js`;
                    script.type = 'text/javascript';
                    script.src = apiSrc;

                    script.onload = async () => {
                        try {
                            if (!window.Microsoft?.CIFramework) {
                                throw new Error('CIFramework not loaded');
                            }
                            // Always set to Docked mode (1) on initialization
                            await Microsoft.CIFramework.setMode(1);
                            const mode = await Microsoft.CIFramework.getMode();
                            setCurrentMode(mode);
                            setStatus('Connected');
                            addLog('CIF initialized successfully', 'success');
                        } catch (err) {
                            setStatus('Error');
                            addLog(`Initialization error: ${err.message}`, 'error');
                        }
                    };

                    script.onerror = () => {
                        setStatus('Error');
                        addLog(`Failed to load CIF library from ${apiSrc}`, 'error');
                    };

                    document.body.appendChild(script);
                } catch (err) {
                    setStatus('Error');
                    addLog(`Initialization error: ${err.message}`, 'error');
                }
            };

            // CIF Function definitions
            const cifFunctions = {
                getMode: {
                    name: 'getMode',
                    description: 'Get current panel mode',
                    execute: async () => {
                        const mode = await Microsoft.CIFramework.getMode();
                        return `Current mode: ${mode} (${['Minimized', 'Docked', 'Hidden'][mode]})`;
                    }
                },
                setMode: {
                    name: 'setMode',
                    description: 'Set panel mode (0: Minimized, 1: Docked, 2: Hidden)',
                    params: true,
                    execute: async (params) => {
                        const mode = parseInt(params);
                        if (isNaN(mode) || mode < 0 || mode > 2) {
                            throw new Error('Invalid mode. Use 0, 1, or 2');
                        }
                        await Microsoft.CIFramework.setMode(mode);
                        setCurrentMode(mode);
                        return `Mode set to: ${mode} (${['Minimized', 'Docked', 'Hidden'][mode]})`;
                    }
                },
                getFocusedTab: {
                    name: 'getFocusedTab',
                    description: 'Get focused tab information',
                    execute: async () => {
                        const tab = await Microsoft.CIFramework.getFocusedTab();
                        return `Focused tab: ${JSON.stringify(tab)}`;
                    }
                },
                getTabInfo: {
                    name: 'getTabInfo',
                    description: 'Get info for specific tab (provide tabId)',
                    params: true,
                    execute: async (params) => {
                        const info = await Microsoft.CIFramework.getTabInfo(params);
                        return `Tab info: ${JSON.stringify(info)}`;
                    }
                }
            };

            // Execute selected function
            const executeFunction = async () => {
                if (!selectedFunction) {
                    addLog('Please select a function to execute', 'warning');
                    return;
                }

                const func = cifFunctions[selectedFunction];
                try {
                    addLog(`Executing ${func.name}...`);
                    const result = await func.execute(functionParams);
                    addLog(`Result: ${result}`, 'success');
                } catch (err) {
                    addLog(`Error: ${err.message}`, 'error');
                }
            };

            // Clear logs
            const clearLogs = () => {
                setLogs([]);
                addLog('Logs cleared');
            };

            React.useEffect(() => {
                initializeCIF();
            }, []);

            return React.createElement('div', { 
                className: 'max-w-6xl mx-auto'
            }, [
                // Header
                React.createElement('div', {
                    key: 'header',
                    className: 'bg-white rounded-lg shadow-lg p-6 mb-6'
                }, [
                    React.createElement('h1', {
                        className: 'text-2xl font-bold mb-2'
                    }, 'Dynamics 365 CIF Testing Dashboard'),
                    React.createElement('div', {
                        className: 'flex items-center space-x-2'
                    }, [
                        React.createElement('span', {
                            className: `h-3 w-3 rounded-full ${
                                status === 'Connected' ? 'bg-green-500' :
                                status === 'Error' ? 'bg-red-500' :
                                'bg-yellow-500'
                            }`
                        }),
                        React.createElement('span', {
                            className: 'text-gray-600'
                        }, `Status: ${status}`)
                    ])
                ]),

                // Function Testing Panel
                React.createElement('div', {
                    key: 'testing-panel',
                    className: 'grid grid-cols-1 md:grid-cols-2 gap-6'
                }, [
                    // Controls
                    React.createElement('div', {
                        className: 'bg-white rounded-lg shadow-lg p-6'
                    }, [
                        React.createElement('h2', {
                            className: 'text-xl font-semibold mb-4'
                        }, 'Function Testing'),
                        
                        // Function selector
                        React.createElement('select', {
                            className: 'w-full p-2 border rounded mb-4',
                            value: selectedFunction,
                            onChange: (e) => setSelectedFunction(e.target.value)
                        }, [
                            React.createElement('option', { value: '' }, 'Select a function'),
                            ...Object.entries(cifFunctions).map(([key, func]) =>
                                React.createElement('option', {
                                    key,
                                    value: key
                                }, `${func.name} - ${func.description}`)
                            )
                        ]),

                        // Parameters input
                        selectedFunction && cifFunctions[selectedFunction].params &&
                        React.createElement('input', {
                            className: 'w-full p-2 border rounded mb-4',
                            placeholder: 'Enter parameters',
                            value: functionParams,
                            onChange: (e) => setFunctionParams(e.target.value)
                        }),

                        // Execute button
                        React.createElement('button', {
                            className: 'w-full bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700',
                            onClick: executeFunction
                        }, 'Execute Function')
                    ]),

                    // Logs
                    React.createElement('div', {
                        className: 'bg-white rounded-lg shadow-lg p-6'
                    }, [
                        React.createElement('div', {
                            className: 'flex justify-between items-center mb-4'
                        }, [
                            React.createElement('h2', {
                                className: 'text-xl font-semibold'
                            }, 'Execution Logs'),
                            React.createElement('button', {
                                className: 'text-gray-500 hover:text-gray-700',
                                onClick: clearLogs
                            }, 'Clear Logs')
                        ]),
                        React.createElement('div', {
                            className: 'h-96 overflow-y-auto space-y-2'
                        }, logs.map((log, index) =>
                            React.createElement('div', {
                                key: index,
                                className: `p-2 rounded ${
                                    log.type === 'error' ? 'bg-red-50 text-red-700' :
                                    log.type === 'success' ? 'bg-green-50 text-green-700' :
                                    log.type === 'warning' ? 'bg-yellow-50 text-yellow-700' :
                                    'bg-gray-50 text-gray-700'
                                }`
                            }, [
                                React.createElement('span', {
                                    className: 'text-xs opacity-75'
                                }, log.timestamp),
                                React.createElement('span', {
                                    className: 'ml-2'
                                }, log.message)
                            ])
                        ))
                    ])
                ])
            ]);
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(CIFTestDashboard));
    </script>
</body>
</html>
