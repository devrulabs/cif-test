<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamics 365 CIF Panel</title>
    
    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div id="root"></div>

    <script>
        // Constants and Enums
        const DisplayMode = Object.freeze({
            Minimized: 0,
            Docked: 1,
            Hidden: 2
        });

        // Icon Components
        const Icons = {
            CheckCircle: ({ className }) => React.createElement('svg', {
                xmlns: 'http://www.w3.org/2000/svg',
                className,
                fill: 'none',
                viewBox: '0 0 24 24',
                stroke: 'currentColor'
            }, React.createElement('path', {
                strokeLinecap: 'round',
                strokeLinejoin: 'round',
                strokeWidth: 2,
                d: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'
            })),

            AlertCircle: ({ className }) => React.createElement('svg', {
                xmlns: 'http://www.w3.org/2000/svg',
                className,
                fill: 'none',
                viewBox: '0 0 24 24',
                stroke: 'currentColor'
            }, React.createElement('path', {
                strokeLinecap: 'round',
                strokeLinejoin: 'round',
                strokeWidth: 2,
                d: 'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'
            })),

            Minimize: ({ className }) => React.createElement('svg', {
                xmlns: 'http://www.w3.org/2000/svg',
                className,
                fill: 'none',
                viewBox: '0 0 24 24',
                stroke: 'currentColor'
            }, React.createElement('path', {
                strokeLinecap: 'round',
                strokeLinejoin: 'round',
                strokeWidth: 2,
                d: 'M19 9l-7 7-7-7'
            })),

            Maximize: ({ className }) => React.createElement('svg', {
                xmlns: 'http://www.w3.org/2000/svg',
                className,
                fill: 'none',
                viewBox: '0 0 24 24',
                stroke: 'currentColor'
            }, React.createElement('path', {
                strokeLinecap: 'round',
                strokeLinejoin: 'round',
                strokeWidth: 2,
                d: 'M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4'
            })),

            EyeOff: ({ className }) => React.createElement('svg', {
                xmlns: 'http://www.w3.org/2000/svg',
                className,
                fill: 'none',
                viewBox: '0 0 24 24',
                stroke: 'currentColor'
            }, React.createElement('path', {
                strokeLinecap: 'round',
                strokeLinejoin: 'round',
                strokeWidth: 2,
                d: 'M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21'
            })),

            Eye: ({ className }) => React.createElement('svg', {
                xmlns: 'http://www.w3.org/2000/svg',
                className,
                fill: 'none',
                viewBox: '0 0 24 24',
                stroke: 'currentColor'
            }, React.createElement('path', {
                strokeLinecap: 'round',
                strokeLinejoin: 'round',
                strokeWidth: 2,
                d: 'M15 12a3 3 0 11-6 0 3 3 0 016 0z'
            }), React.createElement('path', {
                strokeLinecap: 'round',
                strokeLinejoin: 'round',
                strokeWidth: 2,
                d: 'M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z'
            }))
        };

        // Main Component
        const DynamicsCIFPanel = () => {
            const [status, setStatus] = React.useState('Initializing...');
            const [currentMode, setCurrentMode] = React.useState(null);
            const [error, setError] = React.useState(null);
            const [isLoaded, setIsLoaded] = React.useState(false);

            const getDisplayModeName = (mode) => {
                return Object.keys(DisplayMode).find(key => DisplayMode[key] === mode);
            };

            const initializeCIF = async () => {
                try {
                    const script = document.createElement('script');
                    const apiSrc = `${document.referrer}/webresources/Widget/msdyn_ciLibrary.js`;

                    script.type = 'text/javascript';
                    script.src = apiSrc;

                    script.onload = async () => {
                        const ciFramework = window.Microsoft?.CIFramework;
                        
                        if (!ciFramework) {
                            throw new Error('CIFramework could not be loaded');
                        }

                        setIsLoaded(true);
                        const mode = await ciFramework.getMode();
                        setCurrentMode(mode);
                        setStatus('Connected');
                    };

                    script.onerror = () => {
                        throw new Error(`Could not load the CIF library (${apiSrc})`);
                    };

                    document.body.appendChild(script);
                } catch (err) {
                    setError(err.message);
                    setStatus('Error');
                }
            };

            const handleModeChange = async (newMode) => {
                try {
                    const ciFramework = window.Microsoft?.CIFramework;
                    if (!ciFramework) {
                        throw new Error('CIFramework not available');
                    }

                    await ciFramework.setMode(newMode);
                    setCurrentMode(newMode);
                    setStatus(`Mode changed to ${getDisplayModeName(newMode)}`);
                } catch (err) {
                    setError(err.message);
                }
            };

            React.useEffect(() => {
                initializeCIF();
            }, []);

            return React.createElement('div', { 
                className: 'max-w-lg w-full mx-auto p-6 bg-white rounded-lg shadow-lg'
            }, [
                React.createElement('div', { 
                    key: 'header',
                    className: 'mb-6'
                }, [
                    React.createElement('h2', { 
                        className: 'text-2xl font-bold mb-2'
                    }, 'Dynamics 365 CIF Panel'),
                    React.createElement('div', { 
                        className: 'flex items-center space-x-2'
                    }, [
                        React.createElement(status === 'Connected' ? Icons.CheckCircle : Icons.AlertCircle, {
                            key: 'status-icon',
                            className: `w-5 h-5 ${status === 'Connected' ? 'text-green-500' : 'text-yellow-500'}`
                        }),
                        React.createElement('span', { 
                            className: 'text-gray-600'
                        }, status)
                    ])
                ]),

                error && React.createElement('div', {
                    key: 'error',
                    className: 'mb-6 p-4 bg-red-50 border border-red-200 rounded-md text-red-700'
                }, error),

                isLoaded && React.createElement('div', {
                    key: 'controls',
                    className: 'space-y-4'
                }, [
                    React.createElement('div', {
                        key: 'current-mode',
                        className: 'p-4 bg-gray-50 rounded-md'
                    }, [
                        React.createElement('div', {
                            className: 'text-sm text-gray-500 mb-2'
                        }, 'Current Mode'),
                        React.createElement('div', {
                            className: 'font-medium'
                        }, getDisplayModeName(currentMode))
                    ]),

                    React.createElement('div', {
                        key: 'mode-buttons',
                        className: 'grid grid-cols-3 gap-4'
                    }, [
                        {
                            mode: 'Minimized',
                            icon: Icons.Minimize,
                            value: DisplayMode.Minimized
                        },
                        {
                            mode: 'Docked',
                            icon: Icons.Maximize,
                            value: DisplayMode.Docked
                        },
                        {
                            mode: 'Hidden',
                            icon: currentMode === DisplayMode.Hidden ? Icons.Eye : Icons.EyeOff,
                            value: DisplayMode.Hidden
                        }
                    ].map(({ mode, icon: Icon, value }) => 
                        React.createElement('button', {
                            key: mode,
                            onClick: () => handleModeChange(value),
                            className: `p-4 rounded-md flex flex-col items-center justify-center space-y-2 ${
                                currentMode === value
                                    ? 'bg-purple-100 text-purple-700 border-2 border-purple-300'
                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                            }`
                        }, [
                            React.createElement(Icon, {
                                key: `${mode}-icon`,
                                className: 'w-6 h-6'
                            }),
                            React.createElement('span', {
                                key: `${mode}-text`
                            }, mode)
                        ])
                    ))
                ])
            ]);
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(DynamicsCIFPanel));
    </script>
</body>
</html>
